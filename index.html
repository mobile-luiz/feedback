<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Feedback - RH Pro</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --bg: #f4f7f6;
      --success: #27ae60;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
    
    .container {
      background: white; padding: 30px; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
    }

    h2 { color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--secondary); padding-bottom: 10px; }

    label { display: block; margin: 15px 0 5px; color: #555; font-weight: 600; }
    
    input, select, textarea {
      width: 100%; padding: 12px; border: 1px solid #ddd;
      border-radius: 6px; box-sizing: border-box; font-size: 14px;
    }

    textarea { height: 100px; resize: vertical; }

    .signature-pad {
      border: 2px dashed #bbb; border-radius: 8px;
      position: relative; height: 180px; width: 100%;
      background: #fafafa; cursor: crosshair; touch-action: none;
    }
    
    canvas { width: 100%; height: 100%; display: block; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; }

    button {
      padding: 12px; border: none; border-radius: 6px; cursor: pointer;
      font-weight: bold; flex: 1; transition: 0.3s;
    }

    .btn-clear { background: #e74c3c; color: white; }
    .btn-submit { background: var(--success); color: white; }
    
    button:hover { opacity: 0.9; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    .loader { display: none; text-align: center; margin-top: 15px; color: var(--primary); font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h2>üìù Registro de Feedback</h2>
  
  <form id="feedbackForm">
    <label>Nome do Gestor</label>
    <input type="text" id="gestor" placeholder="Quem est√° aplicando?" required>

    <label>Nome do Colaborador (Matr√≠cula - Nome)</label>
    <select id="colaborador" required disabled>
      <option value="">Carregando colaboradores...</option>
    </select>

    <label>Tipo de Feedback</label>
    <select id="tipo" required>
      <option value="">Selecione o tipo...</option>
      <option value="Elogio">Elogio</option>
      <option value="Orienta√ß√£o">Orienta√ß√£o T√©cnica</option>
      <option value="Comportamental">Comportamental</option>
      <option value="PDI">Acompanhamento PDI</option>
    </select>

    <label>Descri√ß√£o do Feedback</label>
    <textarea id="mensagem" placeholder="Descreva os pontos abordados..." required></textarea>

    <label>Assinatura do Colaborador</label>
    <div class="signature-pad" id="signature-pad">
      <canvas id="canvas"></canvas>
    </div>
    <div style="text-align: right; font-size: 11px; color: #888; margin-top: 4px;">Assine dentro da caixa acima</div>

    <div class="btn-group">
      <button type="button" class="btn-clear" onclick="clearCanvas()">Limpar Assinatura</button>
      <button type="submit" class="btn-submit" id="btnEnviar">Registrar Feedback</button>
    </div>
    
    <div class="loader" id="loader">Enviando para o sistema...</div>
  </form>
</div>

<script>
  // 1. URL DO SEU SCRIPT (MANTENHA A SUA URL AQUI)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIaD028LblElmVODfgqV2AgwNvbjW9hKVvOxvHIhdJlkHfHegNYzI6vij5bMKahRlK8A/exec";

  // 2. CARREGAMENTO DOS COLABORADORES VIA FETCH
  window.addEventListener('load', function() {
    const select = document.getElementById('colaborador');
    
    fetch(SCRIPT_URL + "?getLista=true")
      .then(response => response.json())
      .then(lista => {
        select.innerHTML = '<option value="">Selecione o colaborador...</option>';
        if (lista.length === 0) {
          select.innerHTML = '<option value="">Nenhum colaborador encontrado</option>';
          return;
        }
        lista.forEach(item => {
          let opt = document.createElement('option');
          let textoCompleto = item.matricula + " - " + item.nome;
          opt.value = textoCompleto;
          opt.text = textoCompleto;
          select.appendChild(opt);
        });
        select.disabled = false;
      })
      .catch(err => {
        console.error("Erro ao carregar lista:", err);
        select.innerHTML = '<option value="">Erro ao carregar (verifique a conex√£o)</option>';
      });
  });

  // 3. L√ìGICA DA ASSINATURA (CANVAS)
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let writingMode = false;

  function resizeCanvas() {
    const parent = document.getElementById('signature-pad');
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const getPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  const startDrawing = (e) => {
    e.preventDefault();
    writingMode = true;
    const { x, y } = getPos(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
  }

  const draw = (e) => {
    if (!writingMode) return;
    e.preventDefault();
    const { x, y } = getPos(e);
    ctx.lineTo(x, y);
    ctx.stroke();
  }

  const stopDrawing = () => { writingMode = false; }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('touchstart', startDrawing);
  canvas.addEventListener('touchmove', draw, {passive: false});
  canvas.addEventListener('touchend', stopDrawing);

  function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

  function isCanvasBlank() {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
  }

  // 4. ENVIO DOS DADOS (POST)
  document.getElementById('feedbackForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (isCanvasBlank()) {
      alert("‚ö†Ô∏è O colaborador deve assinar antes de enviar.");
      return;
    }

    const btn = document.getElementById('btnEnviar');
    const loader = document.getElementById('loader');
    
    btn.disabled = true;
    btn.innerText = "Enviando...";
    loader.style.display = "block";

    const formData = {
      gestor: document.getElementById('gestor').value,
      colaborador: document.getElementById('colaborador').value,
      tipo: document.getElementById('tipo').value,
      mensagem: document.getElementById('mensagem').value,
      assinatura: canvas.toDataURL()
    };

    fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
      if(data.result === "success") {
        alert("‚úÖ Feedback registrado com sucesso!");
        document.getElementById('feedbackForm').reset();
        clearCanvas();
      } else {
        alert("‚ùå Erro no servidor: " + data.error);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert("Feedback enviado! (Se a planilha atualizou, ignore esta mensagem de erro de rede).");
      document.getElementById('feedbackForm').reset();
      clearCanvas();
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerText = "Registrar Feedback";
      loader.style.display = "none";
    });
  });
</script>

</body>
</html>